<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Project – Engineering Portfolio</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="container">
    <header class="nav">
      <div class="nav-left">
        <a href="index.html" class="back-link">← Back to projects</a>
        <h1 id="title" class="site-title site-title--small"></h1>
        <p id="summary" class="detail-summary"></p>
      </div>

      <nav class="nav-links">
        <a href="index.html" class="active">Projects</a>
        <a href="https://www.linkedin.com/in/esteban-caicedo/" target="_blank" rel="noreferrer">LinkedIn</a>
      </nav>
    </header>

    <main>
      <section class="detail">
        <!-- 3D viewer -->
        <section class="viewer" id="viewer" aria-label="3D model viewer">
          <!-- Model or fallback text -->
        </section>

        <!-- gallery -->
        <section class="detail-media">
          <div id="gallery" class="slider detail-gallery" aria-label="Project media gallery"></div>
        </section>
      </section>
    </main>
  </div>

  <!-- LIGHTBOX para ver imágenes/videos en grande -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <div class="lightbox-backdrop"></div>
    <div class="lightbox-inner">
      <button class="lightbox-close" aria-label="Close">×</button>
      <div class="lightbox-content"></div>
    </div>
  </div>

  <script>
  // ====== utils ======
  const isVideo=(src)=>/\.(mp4|webm|ogg)$/i.test(src);

  function makeMediaEl(src){
    if(isVideo(src)){
      const v=document.createElement('video');
      v.src=src;
      v.muted=true;
      v.loop=true;
      v.autoplay=true;
      v.playsInline=true;
      v.preload='metadata';
      v.setAttribute('disablepictureinpicture','');

      // Controles al pasar el mouse
      v.addEventListener('mouseenter', ()=>{
        v.controls = true;
        v.muted = false;
      });
      v.addEventListener('mouseleave', ()=>{
        v.controls = false;
        v.muted = true;
      });

      return v;
    }
    const img=new Image();
    img.src=src;
    img.alt='';
    img.loading='lazy';
    return img;
  }

  // ====== Lightbox ======
  function openLightbox(src) {
    const lb = document.getElementById('lightbox');
    const content = lb.querySelector('.lightbox-content');
    content.innerHTML = '';

    if (isVideo(src)) {
      const v = document.createElement('video');
      v.src = src;
      v.controls = true;
      v.autoplay = true;
      v.style.width = '100%';
      v.style.maxHeight = '80vh';
      v.style.objectFit = 'contain';
      content.appendChild(v);
    } else {
      const img = new Image();
      img.src = src;
      img.alt = '';
      img.style.width = '100%';
      img.style.maxHeight = '80vh';
      img.style.objectFit = 'contain';
      content.appendChild(img);
    }

    lb.classList.add('open');
    lb.setAttribute('aria-hidden','false');
  }

  function closeLightbox() {
    const lb = document.getElementById('lightbox');
    lb.classList.remove('open');
    lb.setAttribute('aria-hidden','true');
    const content = lb.querySelector('.lightbox-content');
    content.innerHTML = '';
  }

  document.addEventListener('DOMContentLoaded', () => {
    const lb = document.getElementById('lightbox');
    const closeBtn = lb.querySelector('.lightbox-close');
    const backdrop = lb.querySelector('.lightbox-backdrop');

    closeBtn.addEventListener('click', closeLightbox);
    backdrop.addEventListener('click', closeLightbox);

    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') closeLightbox();
    });
  });

  // ====== Slider con soporte para lightbox ======
  function mountMediaSlider(container, mediaPaths, heightPx, opts){
    opts=opts||{};
    const autoplay=opts.autoplay!==false;
    const interval=opts.interval||3000;
    container.classList.add('slider');
    if(heightPx) container.style.height=heightPx+'px';

    if (!mediaPaths || !mediaPaths.length) {
      container.classList.add('slider--empty');
      container.innerHTML = '<div class="slider-empty-msg">No media for this project.</div>';
      return;
    }

    const a=document.createElement('div');a.className='slide-layer active';
    const b=document.createElement('div');b.className='slide-layer';
    let useA=true, idx=0, timer=null;

    a.appendChild(makeMediaEl(mediaPaths[0]||''));
    b.appendChild(makeMediaEl(mediaPaths[1]||mediaPaths[0]||''));
    container.append(a,b);

    const left=document.createElement('div'); left.className='ctrl left'; left.textContent='‹';
    const right=document.createElement('div'); right.className='ctrl right'; right.textContent='›';
    container.append(left,right);

    let dots=null;
    if(mediaPaths.length>1){
      dots=document.createElement('div');dots.className='dots';
      mediaPaths.forEach((_,i)=>{
        const d=document.createElement('span');
        d.className='dot'+(i===0?' active':'');
        d.onclick=()=>show(i);
        dots.appendChild(d);
      });
      container.appendChild(dots);
    }

    function show(nextIndex){
      idx=(nextIndex+mediaPaths.length)%mediaPaths.length;
      const target=(useA?b:a);
      target.innerHTML='';
      target.appendChild(makeMediaEl(mediaPaths[idx]||''));
      (useA?a:b).classList.remove('active');
      (useA?b:a).classList.add('active');
      useA=!useA;
      if(dots){
        dots.childNodes.forEach((d,i)=>d.className='dot'+(i===idx?' active':''));
      }
    }

    left.onclick=()=>show(idx-1);
    right.onclick=()=>show(idx+1);

    function start(){
      if(autoplay && mediaPaths.length>1) timer=setInterval(()=>show(idx+1), interval);
    }
    function stop(){
      if(timer){clearInterval(timer); timer=null;}
    }
    container.addEventListener('mouseenter',stop);
    container.addEventListener('mouseleave',start);
    start();

    // click en la imagen/video → lightbox
    container.addEventListener('click', (e)=>{
      // ignorar clicks en flechas y dots
      if (e.target.classList.contains('ctrl') || e.target.classList.contains('dot')) return;
      const currentSrc = mediaPaths[idx];
      if (!currentSrc) return;
      openLightbox(currentSrc);
    });
  }

  // ====== 3D viewer ======
  function mountModel(container, src) {
    if (!src) {
      container.innerHTML='<div class="viewer-empty">No 3D model for this project.</div>';
      return;
    }

    const tag = document.createElement('model-viewer');
    tag.setAttribute('src', src);
    tag.setAttribute('camera-controls','');
    tag.setAttribute('auto-rotate','');
    tag.setAttribute('exposure','1.0');
    tag.setAttribute('shadow-intensity','0.7');
    tag.style.width='100%';
    tag.style.height='100%';
    tag.addEventListener('error', ()=>{
      container.innerHTML='<div class="viewer-empty">Model preview not available.</div>';
    });
    container.innerHTML='';
    container.appendChild(tag);

    if (!customElements.get('model-viewer')) {
      const s=document.createElement('script');
      s.type='module';
      s.src='https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js';
      document.head.appendChild(s);
    }
  }

  // ====== load & render ======
  (async function(){
    const params=new URLSearchParams(location.search);
    const slug=params.get('slug');

    const res=await fetch('projects.json',{cache:'no-store'});
    const list=await res.json();
    const p=list.find(x=>x.slug===slug) || list[0];

    document.title = (p.title ? p.title + ' – Engineering Portfolio' : 'Project – Engineering Portfolio');
    document.getElementById('title').textContent = p.title || 'Project';

    // Descripción corta debajo del título (por ahora puedes usar p.description)
    const summaryText = p.description || p.longDescription || '';
    document.getElementById('summary').textContent = summaryText;

    // viewer
    mountModel(document.getElementById('viewer'), p.model || '');

    // gallery
    const media=[...(p.images||[]), ...(p.videos||[])];
    mountMediaSlider(document.getElementById('gallery'), media, 0, {autoplay:true});
  })();
  </script>
</body>
</html>
