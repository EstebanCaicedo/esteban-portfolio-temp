<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Project</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Tailwind CDN solo para utilidades ya usadas en v2.6.0 -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0b1220] text-white font-sans">
  <header class="w-full max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
    <a href="index.html" class="text-indigo-300 hover:text-indigo-200">&larr; Back</a>
    <nav class="flex items-center gap-6 text-sm text-zinc-300">
      <a href="index.html#projects" class="hover:text-white">Projects</a>
      <a href="https://www.linkedin.com/in/esteban-caicedo-/" target="_blank" class="hover:text-white">LinkedIn</a>
    </nav>
  </header>

  <main class="w-full max-w-7xl mx-auto px-6 pb-14">
    <div id="titleRow" class="hidden md:grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Viewer (izquierda) -->
      <div id="viewer" class="rounded-3xl bg-[#12182a] min-h-[520px]"></div>

      <!-- Panel (derecha) -->
      <article class="rounded-3xl bg-[#12182a] p-6">
        <h1 id="projTitle" class="text-3xl font-semibold mb-2">—</h1>
        <p id="projLong" class="text-zinc-300 mb-4">—</p>

        <!-- Carrusel -->
        <div id="carousel" class="relative rounded-2xl overflow-hidden bg-black/10">
          <div id="slides" class="relative"></div>

          <!-- Flechas -->
          <button id="prevBtn" class="nav-btn left-3" aria-label="Prev">&#8249;</button>
          <button id="nextBtn" class="nav-btn right-3" aria-label="Next">&#8250;</button>

          <!-- Dots -->
          <div id="dots" class="absolute bottom-3 inset-x-0 flex items-center justify-center gap-2"></div>
        </div>
      </article>
    </div>
  </main>

  <footer class="w-full max-w-7xl mx-auto px-6 pb-16 text-center text-zinc-400">
    © 2025 Esteban Caicedo
  </footer>

  <!-- ThreeJS desde CDN (módulos) -->
  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { GLTFLoader }  from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js";

    // Util core — slider simple con imágenes y videos
    function mountCarousel(container, mediaList) {
      const slides = container.querySelector('#slides');
      const dots   = container.querySelector('#dots');
      const prev   = container.querySelector('#prevBtn');
      const next   = container.querySelector('#nextBtn');

      let idx = 0, nodes = [];

      function createSlide(src) {
        const ext = src.split('.').pop().toLowerCase();
        const wrap = document.createElement('div');
        wrap.className = "w-full";
        wrap.style.cssText = "position:relative; aspect-ratio:16/9; display:none;";

        if (['mp4','webm','ogg'].includes(ext)) {
          const v = document.createElement('video');
          v.src = src;
          v.playsInline = true;
          v.controls = true;
          v.style.cssText = "width:100%; height:100%; object-fit:cover; display:block;";
          wrap.appendChild(v);
        } else {
          const img = document.createElement('img');
          img.src = src;
          img.loading = "lazy";
          img.alt = "";
          img.style.cssText = "width:100%; height:100%; object-fit:cover; display:block;";
          wrap.appendChild(img);
        }
        return wrap;
      }

      function render() {
        slides.innerHTML = "";
        dots.innerHTML = "";
        nodes = mediaList.map(src => createSlide(src));
        nodes.forEach(n => slides.appendChild(n));
        mediaList.forEach((_,i)=>{
          const d=document.createElement('span');
          d.className="dot";
          d.addEventListener('click', ()=>show(i));
          dots.appendChild(d);
        });
        show(0);
      }

      function show(i) {
        idx = (i+nodes.length) % nodes.length;
        nodes.forEach((n,j)=> n.style.display = (j===idx?'block':'none'));
        [...dots.children].forEach((d,j)=> d.classList.toggle('dot-active', j===idx));
      }

      prev.addEventListener('click', ()=>show(idx-1));
      next.addEventListener('click', ()=>show(idx+1));

      render();
    }

    // ThreeJS viewer básico
    function mountViewer(el, glbPath) {
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0b1220);

      const camera = new THREE.PerspectiveCamera(50, el.clientWidth/el.clientHeight, 0.1, 1000);
      camera.position.set(2.2, 1.6, 3.2);

      const renderer = new THREE.WebGLRenderer({ antialias:true });
      renderer.setSize(el.clientWidth, el.clientHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      el.appendChild(renderer.domElement);

      const hemi = new THREE.HemisphereLight(0xffffff,0x222233, 1.0);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 1.2);
      dir.position.set(3,5,4);
      scene.add(dir);

      const grid = new THREE.GridHelper(6, 12, 0x334155, 0x1f2937);
      grid.position.y = -0.001;
      scene.add(grid);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Cargar GLB
      const loader = new GLTFLoader();
      loader.load(glbPath, (gltf)=>{
        const root = gltf.scene;
        root.traverse(o=>{
          if (o.isMesh) {
            o.castShadow = o.receiveShadow = true;
            if (o.material && o.material.metalness !== undefined) {
              o.material.metalness = 0.1;
              o.material.roughness = 0.8;
            }
          }
        });
        // centrado aproximado
        const box = new THREE.Box3().setFromObject(root);
        const size = box.getSize(new THREE.Vector3()).length();
        const center = box.getCenter(new THREE.Vector3());
        root.position.sub(center);
        scene.add(root);
        camera.position.set(size*0.35, size*0.28, size*0.5);
        controls.update();
      });

      function onResize(){
        const w = el.clientWidth, h = el.clientHeight;
        renderer.setSize(w,h);
        camera.aspect = w/h;
        camera.updateProjectionMatrix();
      }
      window.addEventListener('resize', onResize);

      (function loop(){
        requestAnimationFrame(loop);
        controls.update();
        renderer.render(scene,camera);
      })();
    }

    // --------------------------
    // Carga de datos por slug
    // --------------------------
    const params = new URLSearchParams(location.search);
    const slug   = params.get('slug') || '';

    const titleEl = document.getElementById('projTitle');
    const longEl  = document.getElementById('projLong');
    const viewer  = document.getElementById('viewer');
    const carousel= document.getElementById('carousel');
    const layout  = document.getElementById('titleRow');

    fetch('projects.json')
      .then(r=>r.json())
      .then(list=>{
        const proj = list.find(p=>p.slug===slug) || list[0];

        titleEl.textContent = proj.title;
        longEl.textContent  = proj.longDescription || proj.description || '';

        // Viewer
        viewer.innerHTML = ""; // por si se re-navega
        viewer.style.aspectRatio = '16/12';
        mountViewer(viewer, proj.model);

        // Carrusel (imágenes + videos si existen)
        const media = [];
        if (Array.isArray(proj.images)) media.push(...proj.images);
        if (Array.isArray(proj.videos)) media.push(...proj.videos);
        if (media.length === 0 && Array.isArray(proj.images)) media.push(...proj.images);

        mountCarousel(carousel, media);
        layout.classList.remove('hidden');
      })
      .catch(err=>{
        console.error('projects.json error', err);
        layout.classList.remove('hidden');
      });
  </script>
</body>
</html>
